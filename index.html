<script>
const validCredentials={
 "uus":"123","kimjong2":"kimju456","siswa01":"tryout26",
 "koreafan":"hanguk789","topik2026":"seoul2026"
};
const kodeMapping={
 "B12345":"soal1.json","A09008":"soal2.json",
 "W11765":"soal3.json","H66633":"soal4.json"
};
const BASE="https://raw.githubusercontent.com/airnetcso/latbakor/main/soal";
const TOTAL=40, TIME=50*60;

/* STATE */
let questions=[],answers=Array(TOTAL).fill(null);
let cur=0,time=TIME;
let timerInterval=null;
let submitted=false,file="";

/* ===== LOGIN ===== */
function login(){
 const u=document.getElementById("username").value.trim();
 const p=document.getElementById("password").value.trim();
 const k=document.getElementById("kode").value.trim().toUpperCase();

 if(validCredentials[u]===p && kodeMapping[k]){
   file=kodeMapping[k];

   document.getElementById("login-page").style.display="none";
   document.getElementById("quiz-page").style.display="block";

   startTimer();
   load();
 } else {
   alert("Username / password / kode salah");
 }
}

/* ===== TIMER ===== */
function startTimer(){
 const timerEl=document.getElementById("timer");
 timerInterval=setInterval(()=>{
  time--;
  const m=String(Math.floor(time/60)).padStart(2,"0");
  const s=String(time%60).padStart(2,"0");
  timerEl.textContent=`${m}:${s}`;

  if(time<=120) timerEl.style.background="#f44336";
  if(time<=0) submitQuiz(true);
 },1000);
}

/* ===== LOAD ===== */
async function load(){
 const loading=document.getElementById("loading");
 const res=await fetch(`${BASE}/${file}?t=${Date.now()}`);
 questions=await res.json();
 render();
 loading.style.display="none";
 show(0);
}

/* ===== RENDER ===== */
function render(){
 const form=document.getElementById("quiz-form");
 form.innerHTML="";
 questions.forEach((q,i)=>{
  const d=document.createElement("div");
  d.className="question-wrapper";
  d.innerHTML=`
   <div class="card">
     <p><strong>Passage ${i+1}</strong><br>${q.passage}</p>
     ${q.audio?`<audio controls src="${q.audio}"></audio>`:""}
     ${q.image?`<img src="${q.image}">`:""}
   </div>

   <div class="card">
     <div class="question-text">${q.question}</div>
     <div class="options">
       ${Object.entries(q.options).map(([k,v],n)=>`
        <label class="option">
          <input type="radio" name="q${i}" value="${k}">
          <div class="num">${n+1}</div>
          <div class="opt-text">${v}</div>
        </label>`).join("")}
     </div>
   </div>`;
  
  d.querySelectorAll(".option").forEach(o=>{
    const r=o.querySelector("input");
    o.onclick=()=>{
      d.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
      o.classList.add("selected");
      r.checked=true;
      answers[i]=r.value;
    };
  });
  form.appendChild(d);
 });
}

/* ===== NAV ===== */
function show(n){
 document.querySelectorAll(".question-wrapper")
  .forEach((q,i)=>q.classList.toggle("active",i===n));
 document.getElementById("prev").disabled=n===0;
 document.getElementById("next").disabled=n===TOTAL-1;
 document.getElementById("progress").style.width=((n+1)/TOTAL*100)+"%";
 cur=n;
 window.scrollTo(0,0);
}

document.getElementById("next").onclick=()=>show(cur+1);
document.getElementById("prev").onclick=()=>show(cur-1);
document.getElementById("submit").onclick=()=>confirm("Submit sekarang?")&&submitQuiz();

/* ===== SUBMIT ===== */
function submitQuiz(timeout=false){
 if(submitted) return;
 submitted=true;
 clearInterval(timerInterval);

 let score=0;
 questions.forEach((q,i)=>answers[i]===q.correct&&score++);
 const p=Math.round(score/TOTAL*100);

 const result=document.getElementById("result");
 result.innerHTML=`
 <strong>${timeout?"Waktu Habis":"Selesai"}</strong><br><br>
 Skor ${score}/${TOTAL} (${p}%)<br><br>
 ${p>=80?"Mantap ðŸ”¥":"Latihan lagi ðŸ’ª"}`;
 result.style.display="block";

 document.querySelector(".nav").style.display="none";
}
</script>
